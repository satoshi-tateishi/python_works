<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運用調整 - RFチャンネルリスト検索システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .ch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
        .ch-btn { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; position: relative; background-color: white; padding-bottom: 16px; }
        .ch-btn.disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        .ch-btn.selected { background-color: #eff6ff; color: #2563eb; font-weight: bold; box-shadow: inset 0 0 0 2px #3b82f6; }
        .device-indicators { position: absolute; bottom: 0; left: 0; right: 0; display: flex; flex-direction: column; gap: 2px; padding: 0; }
        .device-bar { width: 100%; height: 4px; }
        .sortable-ghost { opacity: 0.4; background-color: #f3f4f6; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">
    <nav class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
        <div class="flex items-baseline gap-2">
            <h1 class="text-xl font-bold">使用チャンネル選択（アナログ）</h1>
            <span class="text-xs opacity-70">{{ version_str }}</span>
        </div>
        <a href="/" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded">検索画面に戻る</a>
    </nav>

    <div class="container mx-auto p-4">
        {% if not venues %}
        <div class="bg-white p-8 rounded-lg shadow text-center">
            <p class="text-gray-500 mb-4">キープされている施設がありません。</p>
            <a href="/" class="text-blue-500 underline">検索画面で施設を探す</a>
        </div>
        {% else %}
        <div id="venue-list" class="space-y-6">
            {% for venue in venues %}
            <div class="bg-white p-6 rounded-lg shadow-md venue-card relative flex gap-4" data-venue-json='{{ venue | tojson | safe }}'>
                <div class="drag-handle flex items-center text-gray-300 hover:text-gray-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" /></svg>
                </div>
                <div class="flex-1">
                    <button onclick='unkeepVenue({{ venue | tojson | safe }})' class="absolute top-4 right-4 text-gray-400 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <div class="mb-4">
                        <h2 class="text-xl font-bold text-gray-800">{{ venue['施設名'] }}</h2>
                        <p class="text-sm text-gray-500">{{ venue['都道府県名'] }}{{ venue['住所'] }}</p>
                    </div>
                    <button onclick='exportWSM(this)' class="bg-orange-500 text-white px-4 py-1 rounded text-sm font-bold shadow hover:bg-orange-600">WSM CSV 保存</button>
                    <div class="ch-grid mt-4">
                        {% for ch in range(13, 54) %}
                        {% set ch_key = ch|string + 'CH' %}{% set is_available = venue[ch_key] == '○' %}
                        {% set ch_info_list = tv_channels | selectattr('TVchannel', 'equalto', ch) | list %}{% set ch_info = ch_info_list[0] if ch_info_list else none %}
                        <div class="ch-btn {% if not is_available %}disabled{% endif %}" data-ch="{{ ch }}" onclick="selectChannel(this, {{ ch }})">
                            {{ ch }}
                            <div class="device-indicators">
                                {% if ch_info %}{% for dev in devices %}
                                    {% set color = '#3b82f6' %}{% if 'N' in dev.name %}{% set color = '#22c55e' %}{% endif %}{% if 'SR2050' in dev.name %}{% set color = '#f59e0b' %}{% endif %}
                                    {% set overlap_min = [dev.minfrequency, ch_info.minfrequency] | max %}{% set overlap_max = [dev.maxfrequency, ch_info.maxfrequency] | min %}
                                    {% if overlap_min < overlap_max %}
                                        {% set ch_bw = ch_info.maxfrequency - ch_info.minfrequency %}
                                        <div class="device-bar" style="background-color: {{ color }}; width: {{ (overlap_max - overlap_min) / ch_bw * 100 }}%; margin-left: {{ (overlap_min - ch_info.minfrequency) / ch_bw * 100 }}%;"></div>
                                    {% else %}<div class="device-bar bg-transparent"></div>{% endif %}
                                {% endfor %}{% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg flex justify-center">
            <button onclick="exportToExcel()" class="bg-green-600 text-white px-12 py-3 rounded-full font-bold shadow-lg hover:bg-green-700">Excel 保存</button>
        </div>
        {% endif %}
    </div>

    <script>
        const el = document.getElementById('venue-list');
        if (el) { Sortable.create(el, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost' }); }
        function selectChannel(el, ch) { if (!el.classList.contains('disabled')) el.classList.toggle('selected'); }
        async function saveAsFile(blob, filename) {
            const reader = new FileReader();
            reader.onload = function() { window.pywebview.api.save_file(reader.result.split(',')[1], filename); };
            reader.readAsDataURL(blob);
        }
        function getFormattedDate() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
        }
        async function exportWSM(btn) {
            const card = btn.closest('.venue-card');
            const vData = JSON.parse(card.dataset.venueJson);
            const chs = Array.from(card.querySelectorAll('.ch-btn.selected')).map(b => parseInt(b.dataset.ch));
            if (chs.length === 0) return alert('CH未選択');
            const res = await fetch('/export_wsm', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({venue: vData, selected_channels: chs}) });
            if (res.ok) await saveAsFile(await res.blob(), `wsm_${vData['施設名']}_${getFormattedDate()}.csv`);
        }
        async function exportToExcel() {
            const selectedData = [];
            document.querySelectorAll('.venue-card').forEach((card) => {
                const chs = Array.from(card.querySelectorAll('.ch-btn.selected')).map(b => parseInt(b.dataset.ch));
                if (chs.length > 0) selectedData.push({venue: JSON.parse(card.dataset.venueJson), selected_channels: chs.sort((a,b)=>a-b)});
            });
            if (selectedData.length === 0) return alert('施設未選択');
            const res = await fetch('/export', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({data: selectedData}) });
            if (res.ok) await saveAsFile(await res.blob(), `運用連絡票_${getFormattedDate()}.xlsx`);
        }
        async function unkeepVenue(vData) {
            if (confirm(`「${vData['施設名']}」をリストから削除しますか？`)) {
                await fetch('/unkeep', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({data:vData})});
                location.reload();
            }
        }
    </script>
</body>
</html>